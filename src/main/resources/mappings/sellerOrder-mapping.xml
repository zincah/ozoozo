<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="SellerOrderDAO">
	
	<!-- 주문건 리스트 -->
	<select id="selectOrderList" resultType="product">
		SELECT * FROM user_order uo 
		JOIN payment p ON p.pay_ordernum  = uo.order_num 
		JOIN product p2 ON p2.product_id = uo.product_id 
		JOIN address a ON a.address_id = uo.address_id
		JOIN product_option po ON po.op_productid = uo.product_id
		WHERE uo.seller_id = #{seller_id}
		ORDER BY uo.order_id DESC;
	</select>
	
	<!-- 판매글 검색 리스트 -->
	<select id="selectSearchOrder" resultType="product">
		SELECT * FROM user_order uo 
		JOIN payment p ON p.pay_ordernum  = uo.order_num 
		JOIN product p2 ON p2.product_id = uo.product_id 
		JOIN address a ON a.address_id = uo.address_id
		JOIN product_option po ON po.op_productid = uo.product_id
		<where>
			<if test="seller_id != null">
				uo.seller_id = #{seller_id}
			</if>
			<if test="sc_searchName != ''">
				<if test="sc_searchNameStatus == 1">
					<trim prefix="and">
						cast(uo.order_id as VARCHAR) LIKE <trim prefix="replace('" suffix="%',' ','')">${sc_searchName}</trim>
					</trim>
				</if>
				<if test="sc_searchNameStatus == 2">
					<trim prefix="and">
						cast(uo.order_num as VARCHAR) LIKE <trim prefix="replace('" suffix="%',' ','')">${sc_searchName}</trim>
					</trim>
				</if>
				<if test="sc_searchNameStatus == 3">
					<trim prefix="and">
						a.receiver LIKE <trim prefix="replace('%" suffix="%',' ','')">${sc_searchName}</trim>
					</trim>
				</if>
			</if>
			<if test="sc_searchStatus != null">
				<trim prefix="and">
					<if test="sc_searchStatus.size != 9">
						<foreach collection="sc_searchStatus" item="arr" separator="or">
							<if test="arr == 2">
								uo.order_status = '결제완료'
							</if>
							<if test="arr == 3">
								uo.order_status = '배송준비중'
							</if>
							<if test="arr == 4">
								uo.order_status = '배송중'
							</if>
							<if test="arr == 5">
								uo.order_status = '배송완료'
							</if>
							<if test="arr == 6">
								uo.order_status = '교환'
							</if>
							<if test="arr == 7">
								uo.order_status = '반품'
							</if>
							<if test="arr == 8">
								uo.order_status = '환불'
							</if>
							<if test="arr == 9">
								uo.order_status = '주문취소'
							</if>
						</foreach>
					</if>
				</trim>
			</if>
			<if test="sc_category != 0">
				<trim prefix="and">
					p2.pro_catecode = #{sc_category}
				</trim>
			</if>
			<if test="sc_middleSelect != 0 and sc_smallSelect == 0">
				<trim prefix="and">
					(p2.pro_subcatecode/100) = (#{sc_middleSelect}/100)
				</trim>
			</if>
			<if test="sc_smallSelect != 0">
				<trim prefix="and">
					p2.pro_subcatecode = #{sc_smallSelect}
				</trim>
			</if>
			<trim prefix="and">
				uo.order_date BETWEEN TO_DATE(#{sc_startDate}, 'YYYY-MM-DD') AND TO_DATE(#{sc_endDate}, 'YYYY-MM-DD') + INTERVAL '1 DAY'
			</trim>
			<if test="true">
				ORDER BY uo.order_date DESC;
			</if>
		</where>
	</select>
	
	<!-- 판매글 상태 업데이트 -->
	<update id="updatePostingStatus" parameterType="product">
		UPDATE product_posting SET post_status = #{post_status} WHERE post_id = #{post_id};
	</update>
	
	<!-- 선택한 판매글 데이터 -->
	<select id="selectSelectPosting" resultType="product">
		SELECT * FROM product_posting pp
		JOIN category c ON pp.po_category = c.cate_code
		LEFT JOIN deal_info di ON pp.post_id = di.deal_postid
		WHERE pp.post_id = #{post_id};
	</select>
	
	<!-- 오늘의딜 신청 업데이트 -->
	<insert id="insertPostingDealApp" parameterType="product">
		INSERT INTO deal_info 
		(deal_id, deal_postid, deal_originprice, deal_saleratio, deal_saleprice, deal_sellerid)
		 VALUES ((SELECT COALESCE(MAX(deal_id), 0)+1 FROM deal_info), 
		 #{post_id}, 
		 (SELECT whole_price FROM product_posting pp WHERE pp.post_id = #{post_id}),
		 (SELECT sale_ratio FROM product_posting pp WHERE pp.post_id = #{post_id})+10,
		 (SELECT whole_price * ((sale_ratio+10)/100.0) FROM product_posting pp WHERE pp.post_id = #{post_id}),
		 #{seller_id});
	</insert>
	
	<!-- 선택한 주문건의 통합 상세정보 (상품 개별 리스트) -->
	<select id="selectOrderDetailData" resultType="product">
		SELECT * FROM user_order uo 
		JOIN product p2 ON p2.product_id = uo.product_id 
		JOIN product_option po ON po.op_productid = uo.product_id
		WHERE uo.seller_id = #{seller_id} AND uo.order_num = #{order_num}
		ORDER BY uo.order_id DESC;
	</select>
	
	<!-- 선택한 주문건의 통합 상세정보 (해당 주문건 결제정보) -->
	<select id="selectOrderDetailPayment" resultType="product">
		SELECT * FROM payment p 
		JOIN user_order uo ON uo.order_id = #{order_id}
		JOIN user_table ut ON ut.user_num = uo.user_num
		JOIN address a ON a.address_id = uo.address_id
		WHERE p.py_sellerid = #{seller_id} AND p.pay_ordernum = #{order_num};
	</select>
</mapper>

