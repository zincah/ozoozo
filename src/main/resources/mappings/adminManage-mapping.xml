<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="AdminManageDAO">

	<!-- 현재 사용하는거 회원관리, 총 검색, 회원정보 수정 -->

	<!-- 회원관리 -->
	<select id="selectUser" resultType="user">
		SELECT user_num, user_email, nickname, gender, reccode, last_login, join_date, user_status, user_type FROM user_table ORDER BY user_num DESC;
	</select>
	
	<!-- 회원 타입으로 select -->
	<select id="selectUserType" resultType="user">
		SELECT user_num, user_email, nickname, gender, reccode, last_login, join_date, user_status, user_type FROM user_table WHERE user_type = #{user_type} ORDER BY user_num DESC;
		
	</select>

	<!-- 회원 상태로 select -->
	<select id="selectUserStatus" resultType="user">
		SELECT user_num, user_email, nickname, gender, reccode, last_login, join_date, user_status, user_type FROM user_table 
		WHERE user_status = #{user_status} ORDER BY user_num DESC;
	</select>
	
	<!-- 회원 가입날짜로 select -->
	<!-- 날짜 다른 vo로 만들어도 되긴함 -->
	<select id="selectUserDate" resultType="user">
		SELECT user_num, user_email, nickname, gender, reccode, last_login, join_date, user_status, user_type FROM user_table 
		WHERE join_date BETWEEN #{startdate} AND #{enddate} ORDER BY user_num DESC;
	</select>
	
	<!-- 회원상태 변경 -->
	<update id="updateUserStatus" parameterType="user">
		UPDATE user_table SET user_status=#{user_status} WHERE user_num = #{user_num};
	</update>
	
	<!-- 실시간 검색 -->
	<select id="useSearchBox" parameterType="user" resultType="user">
		SELECT user_num, user_email, nickname, gender, reccode, last_login, join_date, user_status, user_type FROM user_table 
		<where>
			<if test="pack=='nickname'.toString()">
				nickname LIKE '%'||#{keyword}||'%' ORDER BY user_num DESC
			</if>
			<if test="pack=='email'.toString()">
				user_email LIKE '%'||#{keyword}||'%' ORDER BY user_num DESC
			</if>
		</where>
	</select>
	
	<!-- 총 검색 -->
	<select id="getUserList" parameterType="user" resultType="user">
		SELECT user_num, user_email, nickname, gender, reccode, last_login, join_date, user_status, user_type FROM user_table 
		<where>
			<if test="user_type != ''">
				user_type = #{user_type}
			</if>
			<if test="user_status != null">
				<trim prefix="and">
					user_status = #{user_status}
				</trim>
			</if>
			<if test="enddate != null and startdate != null">
				<trim prefix="and">
					join_date BETWEEN #{startdate} AND #{enddate}
				</trim>
			</if>
			<if test="pack != null">
				<trim prefix="and">
					<if test="pack=='nickname'.toString()">
						nickname LIKE '%'||#{keyword}||'%'
					</if>
					<if test="pack=='email'.toString()">
						user_email LIKE '%'||#{keyword}||'%'
					</if>
				</trim>
			</if>
		</where>
		<trim prefix="order by">
			user_num DESC
		</trim>
		
	</select>
	
	<!-- admin 상품 posting -->
	<select id="selectPosting" resultType="adminproduct">
		SELECT po.post_id, ss.company_name, di.deal_status, po.best_product, po.post_name, pp.product_created, pp.product_count, ca.cate_name, sc.subcate_name, po.post_status, po.post_couponid, pc.coupon_title 
		FROM product_posting po INNER JOIN (
			SELECT MAX(product_created) AS product_created , count(product_postid) AS product_count, product_postid FROM product GROUP BY product_postid 
		) pp ON po.post_id = pp.product_postid
		INNER JOIN seller ss ON po.post_sellerid = ss.seller_id 
		INNER JOIN category ca ON po.po_category = ca.cate_code
		INNER JOIN sub_category sc ON po.po_subcate = sc.subcate_code
		LEFT OUTER JOIN product_coupon pc ON po.post_couponid = pc.coupon_id 
		LEFT OUTER JOIN deal_info di ON po.post_id = di.deal_postid
		ORDER BY po.post_id DESC limit #{amount} offset (#{pageNum}-1) * #{amount};
	</select>
	
	<!-- admin posting size 얻어오기 -->
	<select id="selectPostCount" resultType="int">
		SELECT COUNT(post_id) FROM product_posting;
	</select>
	
	<!-- admin 상품 상태 바꾸기 : product-posting -->
	<update id="updateProductStatus1">
		UPDATE product_posting SET post_status=#{post_status} WHERE post_id=#{post_id};
	</update>
	
	<!-- admin 상품 상태 바꾸기 : product-status -->
	<update id="updateProductStatus2">
		UPDATE product_status AS pos SET status=#{post_status} FROM product AS pp WHERE pos.st_product_id = pp.product_id AND pp.product_postid=#{post_id};
	</update>
	
	<!-- admin 상품에서 쿠폰 검색 -->
	<select id="selectCouponList" resultType="adminproduct">
		SELECT coupon_id, coupon_title, coupon_subtitle FROM product_coupon WHERE coupon_status = '사용중';
	</select>
	
	<!-- admin 쿠폰 상태 바꾸기 : coupon-status -->
	<update id="updateCouponStatus">
		UPDATE product_posting SET post_couponid=#{post_couponid} WHERE post_id=#{post_id};
	</update>
	
	<!-- admin deal 상태 바꾸기 : deal-info, post -->
	<update id="updateDealStatus">
		UPDATE deal_info SET deal_status=#{deal_status} WHERE deal_postid=#{post_id};
	</update>
	
	<update id="updateDealStatusOnPost">
		UPDATE product_posting SET today_deal=#{today_deal} WHERE post_id=#{post_id};
	</update>
	
	<delete id="deleteDeal">
		DELETE FROM deal_info WHERE deal_postid=#{post_id}
	</delete>
	
	
</mapper>